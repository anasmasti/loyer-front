<!--Début de Div qui contient le formulaire form-contrat-->
<div class="form-box mt-4">
  <!--Début Formulaire form-contrat-->
  <form [formGroup]="contratForm" enctype="multipart/form-data">

    <div class="w-100 d-flex justify-content-center">
      <div *ngIf="errors" class="error-alert p-2 my-2">{{ errors }}</div>
      <!-- alert de reussite -->
      <div *ngIf="postDone" class="done-alert p-2 my-2">{{ PostSucces }}</div>
      <div *ngIf="updateDone" class="done-alert p-2 my-2">{{ updateSucces }}</div>
    </div>

    <!--Début 1er Row-->
    <div class="row">
      <!-- Calcul retenue a la source par mois/ total brut loyer / total net loyer -->
      <input type="hidden" class="form-control" [value]="duree" formControlName="duree" />
      <input type="hidden" class="form-control" [value]="retunue_source_par_mois"
        formControlName="retunue_source_par_mois" />
      <input type="hidden" class="form-control" [value]="totalBrutLoyer" formControlName="total_montant_brut_loyer" />
      <input type="hidden" class="form-control" [value]="totalNetLoyer" formControlName="total_montant_net_loyer" />
      <!-- Montant Avance Tax -->
      <input type="hidden" class="form-control" [value]="montant_avance_tax_" formControlName="montant_avance_tax" />

      <!-- Validation inputs -->
      <input type="hidden" class="form-control btn success-btn" formControlName="validation1_DMG" />
      <input type="hidden" class="form-control btn success-btn" formControlName="validation2_DAJC" />
      <input type="hidden" class="form-control btn success-btn" formControlName="numero_contrat" />

      <div class="col-lg-3 form-group mt-4">
        <label for="">Pièce jointe</label>
        <input type="file" class="form-control btn success-btn" formControlName="piece_jointe" accept=".pdf"
          (change)="onFileSelected($event)" />
      </div>

      <div class="col-lg-3 form-group mt-4">
        <label for="">Date de début du loyer</label>
        <input type="date" [(ngModel)]="date_debut_loyer_" class="form-control rounded-pill" (change)="calculMontant();reinitialiserDateDebut()"
          formControlName="date_debut_loyer" required [ngClass]="{
            'is-invalid': checkInputsValidation(date_debut_loyer),
            'is-valid': !date_debut_loyer?.invalid
          }"/>

          <!-- Error Message  -->
      <div class="" *ngIf="checkInputsValidation(date_debut_loyer)">
        <p class="text-danger" *ngIf="date_debut_loyer?.errors?.required">
          Veuillez remplir ce champ
        </p>
      </div>

      </div>

      <div class="col-lg-3 form-group mt-4">
        <label for="">Montant du loyer</label>
        <input type="number" [(ngModel)]="montantLoyer" (keyup)="calculMontant()" class="form-control rounded-pill"
          formControlName="montant_loyer" [ngClass]="{
            'is-invalid': checkInputsValidation(montant_loyer),
            'is-valid': !montant_loyer?.invalid
          }"/>

          <!-- Error Message  -->
      <div class="" *ngIf="checkInputsValidation(montant_loyer)">
        <p class="text-danger" *ngIf="montant_loyer?.errors?.required">
          Veuillez remplir ce champ
        </p>
      </div>
      </div>

      <div class="col-lg-3 form-group mt-4">
        <label for="">Taxe d’édilité comprise dans le loyer</label>
        <input type="text" class="form-control rounded-pill" formControlName="taxe_edilite_comprise_loyer" />
      </div>


      <div class="col-lg-3 form-group mt-4">
        <label for="">Taxe d’édilité non comprise dans le loyer</label>
        <input type="text" class="form-control rounded-pill" formControlName="taxe_edilite_noncomprise_loyer" />
      </div>


      <div class="col-lg-3 form-group mt-4">
        <label for="">Périodicité de paiement</label>
        <!-- <input type="text" class="form-control rounded-pill" formControlName="periodicite_paiement" /> -->
        <select class="form-select rounded-pill" formControlName="periodicite_paiement" [ngClass]="{
          'is-invalid': checkInputsValidation(periodicite_paiement),
          'is-valid': !periodicite_paiement?.invalid
        }" 
        [(ngModel)]="periodicite"
        (change)="reinitialiserDates()"
        >
          <option value="mensuelle" >Mensuelle</option>
          <option value="trimestrielle" >Trimestrielle</option>
          <option value="annuelle">Annuelle</option>
        </select>
          <!-- Error Message  -->
      <div class="" *ngIf="checkInputsValidation(periodicite_paiement)">
        <p class="text-danger" *ngIf="periodicite_paiement?.errors?.required">
          Veuillez remplir ce champ
        </p>
      </div>
      </div>


      <div class="col-lg-3 form-group mt-4">
        <label for="">Durée de location</label>
        <input type="number" class="form-control rounded-pill" formControlName="duree_location" [ngClass]="{
          'is-invalid': checkInputsValidation(duree_location),
          'is-valid': !duree_location?.invalid
        }"/>
         <!-- Error Message  -->
      <div class="" *ngIf="checkInputsValidation(duree_location)">
        <p class="text-danger" *ngIf="duree_location?.errors?.required">
          Veuillez remplir ce champ
        </p>
      </div>
      </div>

      <div class="col-lg-3 form-group mt-4">
        <label for="">Date fin de contrat de bail</label>
        <input type="date" class="form-control rounded-pill" formControlName="date_fin_contrat" [ngClass]="{
          'is-invalid': checkInputsValidation(date_fin_contrat),
          'is-valid': !date_fin_contrat?.invalid
        }">
            <!-- Error Message  -->
      <div class="" *ngIf="checkInputsValidation(date_fin_contrat)">
        <p class="text-danger" *ngIf="date_fin_contrat?.errors?.required">
          Veuillez remplir ce champ
        </p>
      </div>
      </div>

      <div class="col-lg-3 form-group mt-4">
        <label for="">Déclaration d’option</label>
        <select class="form-select rounded-pill" (change)="calculMontant()" [(ngModel)]="hasDeclarationOption"
          formControlName="declaration_option">
          <option value="oui">Oui</option>
          <option value="non">Non</option>
        </select>
      </div>

      <div class="col-lg-3 form-group mt-4">
        <label for="">Taux de l’impôt</label>
        <input type="text" class="form-control rounded-pill" [value]="tauxImpot + '%'" formControlName="taux_impot"
          readonly>
      </div>

      <div class="col-lg-3 form-group mt-4">
        <label for="">Retenue à la source (Annuel) </label>
        <input type="text" [value]="retenueSource" class="form-control rounded-pill" formControlName="retenue_source"
          readonly>
      </div>

      <div class="col-lg-3 form-group mt-4">
        <label for="">Montant après impôt</label>
        <input type="number" class="form-control rounded-pill" [value]="montantApresImpot"
          formControlName="montant_apres_impot" readonly>
      </div>

      <div class="col-lg-3 form-group mt-4">
        <label for="">Montant de la caution</label>
        <input type="number" class="form-control rounded-pill" [(ngModel)]="montantCaution"
          (keyup)="calculEffortCaution()" formControlName="montant_caution">
      </div>

      <div class="col-lg-3 form-group mt-4">
        <label for="">Effort de la caution</label>
        <input type="text" class="form-control rounded-pill" [value]="effortCaution" formControlName="effort_caution"
          readonly>
      </div>

      <div class="col-lg-3 form-group mt-4">
        <label for="">Date de reprise de la caution</label>
        <input type="date" class="form-control rounded-pill" formControlName="date_reprise_caution" [ngClass]="{
          'is-invalid': checkInputsValidation(date_reprise_caution),
          'is-valid': !date_reprise_caution?.invalid
        }">
         <!-- Error Message  -->
      <div class="" *ngIf="checkInputsValidation(date_reprise_caution)">
        <p class="text-danger" *ngIf="date_reprise_caution?.errors?.required">
          Veuillez remplir ce champ
        </p>
      </div>
      </div>

      <div class="col-lg-3 form-group mt-4">
        <label for="">Statut de la caution</label>
        <input type="text" [(ngModel)]="statutCaution" class="form-control rounded-pill" formControlName="statut_caution" readonly>
      </div>

      <div class="col-lg-3 form-group mt-4">
        <label for="">Durée de l’avance</label>
        <input type="number" class="form-control rounded-pill" [(ngModel)]="dureeAvance" (keyup)="calculDate()"
        formControlName="duree_avance"
        [readonly]="periodicite ? false : true">
      </div>

      <div class="col-lg-3 form-group mt-4">
        <label for="">Date fin de l’avance</label>
        <input type="date" class="form-control rounded-pill" [value]="formattedDate" formControlName="date_fin_avance"
          readonly>
      </div>

      <div class="col-lg-3 form-group mt-4">
        <label for="">Date 1er paiement</label>
        <input type="date" class="form-control rounded-pill" [value]="date_1er_paiment" formControlName="date_1er_paiement" readonly>
      </div>

      <div class="col-lg-3 form-group mt-4">
        <label for="">Montant de l’avance</label>
        <input type="number" class="form-control rounded-pill" formControlName="montant_avance" (keyup)="calculMontantAvanceTax()" [readonly]="dureeAvance > 0 ? false : true">
      </div>

      <div class="col-lg-3 form-group mt-4">
        <label for="">N° d’engagement de la dépense</label>
        <input type="text" class="form-control rounded-pill" formControlName="n_engagement_depense">
      </div>

      <div class="col-lg-3 form-group mt-4">
        <label for="">Echéance de révision du loyer</label>
        <input type="text" class="form-control rounded-pill" formControlName="echeance_revision_loyer">
      </div>

      <div *ngIf="update" class="col-lg-3 form-group mt-4">
        <label for="">Etat de contrat</label>
        <select class="form-select rounded-pill" formControlName="etat_contrat_libelle" [(ngModel)]="etatContratTypes"
          (change)="showEtatSection($event)">
          <option value="Actif">Actif</option>
          <!--  -->
          <option *ngIf="this.contrat.validation2_DAJC"
            [value]="etatContratTypes == 'Avenant' ? etatContratTypes : 'Avenant'">à avener</option>
          <option value="Suspendu">à suspendre</option>
          <option value="Résilié">à résilier</option>
        </select>
      </div>

      <div *ngIf="!update && foncier" class="col-lg-3 form-group mt-4">
        <label for="">Addresse du foncier</label>
        <input type="hidden" [(ngModel)]="foncier._id" formControlName="foncier">
        <p>
          <strong>
            {{ foncier.adresse }}
          </strong>
        </p>
      </div>

      <div *ngIf="!update && foncier" class="col-lg-3 form-group mt-4">
        <input type="hidden" [(ngModel)]="foncier.lieu" formControlName="lieu">
      </div>

      <div *ngIf="update" class="col-lg-3 form-group mt-4">
        <input type="hidden" formControlName="lieu">
        <input type="hidden" formControlName="foncier">
      </div>

      <div class="mt-4">
        <div class="form-box mt-2">
          <div *ngIf="etatContratTypes == 'Avenant'; then AV"></div>
          <div *ngIf="etatContratTypes == 'Suspendu'; then SUS"></div>
          <div *ngIf="etatContratTypes == 'Résilié'; then RES"></div>
        </div>
      </div>

      <!-- Template Avenant start -->
      <ng-template #AV>
        <h6>Etat du contrat: &nbsp;<span>Avenant</span></h6>
        <div class="row">

          <div class="col-lg-3 form-group mt-4">
            <label for="">N° Avenant</label>
            <input type="text" class="form-control rounded-pill" formControlName="etat_contrat_n_avenant">
          </div>

          <div class="col-lg-3 form-group mt-4">
            <label for="">Pièce jointe</label>
            <input type="file" class="form-control rounded-pill btn success-btn"
              formControlName="etat_contrat_piece_jointe_avenant" accept=".pdf"
              (change)="onFileSelectedAvenant($event)">
          </div>

          <div class="col-lg-3 form-group mt-4">
            <label for="">Motif</label>
            <!-- <input type="text" class="form-control rounded-pill" formControlName="etat_contrat_motif"> -->
            <select class="form-select rounded-pill" formControlName="etat_contrat_motif">
              <option value="Décès">Décès</option>
              <option value="Cession">Cession</option>
              <option value="Révision_prix_loyer">Révision du prix du loyer</option>
            </select>

          </div>

          <div class="col-lg-3 form-group mt-4">
            <label for="">Montant du nouveau loyer</label>
            <input type="number" class="form-control rounded-pill" formControlName="etat_contrat_montant_nouveau_loyer">
          </div>

          <div class="col-lg-3 form-group mt-4">
            <label for="">Signalétique du successeur</label>
            <input type="text" class="form-control rounded-pill" formControlName="etat_contrat_signaletique_successeur">
          </div>

        </div>

      </ng-template>
      <!-- Template Avenant end -->

      <!-- Template Suspendu start -->
      <ng-template #SUS>

        <h6>Etat du contrat: &nbsp;<span>Suspendu</span></h6>
        <div class="row">
          <div class="col-lg-3 form-group mt-4">
            <label for="">Intitulé de lieu</label>
            <input type="text" class="form-control rounded-pill" formControlName="etat_contrat_intitule_lieu">
          </div>

          <div class="col-lg-3 form-group mt-4">
            <label for="">Date de Suspendu</label>
            <input type="date" class="form-control rounded-pill" formControlName="etat_contrat_date_suspension">
          </div>

          <div class="col-lg-3 form-group mt-4">
            <label for="">Durée de Suspendu</label>
            <input type="number" class="form-control rounded-pill" formControlName="etat_contrat_duree_suspension">
          </div>

          <div class="col-lg-3 form-group mt-4">
            <label for="">Motif de Suspendu</label>
            <input type="text" class="form-control rounded-pill" formControlName="etat_contrat_motif_suspension">
          </div>

        </div>

      </ng-template>
      <!-- Template Suspendu end -->

      <!-- Template Resiliation start -->
      <ng-template #RES>

        <h6>Etat du contrat: &nbsp;<span>Résilié</span></h6>

        <div class="row">
          <div class="col-lg-3 form-group mt-4">
            <label for="">Intitulé de lieu</label>
            <input type="text" class="form-control rounded-pill" formControlName="etat_contrat_intitule_lieu">
          </div>

          <div class="col-lg-3 form-group mt-4">
            <label for="">Reprise caution</label>
            <!-- <input type="text" class="form-control rounded-pill" formControlName="etat_contrat_reprise_caution"> -->
            <select class="form-select rounded-pill" formControlName="etat_contrat_reprise_caution">
              <option value="Consommée">Consommée</option>
              <option value="Récupérée">Récupérée</option>
            </select>
          </div>

          <div class="col-lg-3 form-group mt-4">
            <label for="">Date de Résilié</label>
            <input type="date" class="form-control rounded-pill" (change)="calculMontant()"
              formControlName="etat_contrat_date_resiliation">
          </div>

          <div class="col-lg-3 form-group mt-4">
            <label for="">Etat des lieux de sortie</label>
            <input type="text" class="form-control rounded-pill" formControlName="etat_contrat_etat_lieu_sortie">
          </div>

          <div class="col-lg-3 form-group mt-4">
            <label for="">Images d'état des lieux de sortie</label>
            <input type="file" class="form-control btn success-btn"
              formControlName="etat_contrat_images_etat_res_lieu_sortie" accept=".pdf"
              (change)="onFileSelectedResLieuSortie($event)">
          </div>

          <div class="col-lg-3 form-group mt-4">
            <label for="">Préavis</label>
            <input type="text" class="form-control rounded-pill" formControlName="etat_contrat_preavis">
          </div>

          <div class="col-lg-3 form-group mt-4">
            <label for="">Piéce jointe (la lettre de Résilié scannée)</label>
            <input type="file" class="form-control btn success-btn"
              formControlName="etat_contrat_lettre_res_piece_jointe" accept=".pdf"
              (change)="onFileSelectedLettreRes($event)">
          </div>

        </div>
      </ng-template>
      <!-- Template Resiliation end -->
    </div>

    <!-- Button Ajouter -->
    <div class="form-group mt-5 col-lg-2 d-flex">
    <button *ngIf="!update" type="submit" id="Ajouter" class="btn second-btn form-control" (click)="addNewContrat();">
        Ajouter
      </button>
      <button *ngIf="update" type="submit" id="Modifier" class="btn second-btn form-control" (click)="updateContrat();">
        Modifier
      </button>
    </div>
  </form>
  <!-- Fin de formulaire-->