<div *ngFor="let ctr of contratByFoncier">
  <span class="main-txt">{{ctr?.numero_contrat}}</span> / <span class="info-txt">{{ctr?.foncier.type_lieu}}</span>
</div>

<div id="form_content">
<form [formGroup]="proprietaireForm" (ngSubmit)="update ? updateProprietaire() : addProprietaire()">
  <!-- Message d'ERREUR de serveur -->
  <div class="w-100 d-flex justify-content-center">
    <div *ngIf="errors" class="error-alert p-2 my-2">{{ errors }}</div>
    <!-- Message de succés de serveur -->
    <div *ngIf="updateDone" class="done-alert p-2 my-2">
      {{ Updatesuccess }}
    </div>
    <div *ngIf="postDone" class="done-alert p-2 my-2">{{ PostSucces }}</div>
    <!-- <div *ngIf="checkMontant" class="error-alert p-2 my-2">{{ ErrorMontantLoyer }}</div> -->
  </div>

  <!--Début 1er Row-->
  <div class="row">
    
    <div class="col-lg-3 form-group mt-4">
      <label for="">Nom et prénom <span class="danger-txt">*</span></label>
      <input type="text" class="form-control rounded-pill" formControlName="nom_prenom" [ngClass]="{
          'is-invalid': checkInputsValidation(nom_prenom),
          'is-valid': !nom_prenom?.invalid
        }" />

      <!-- Error Message  -->
      <div class="" *ngIf="checkInputsValidation(nom_prenom)">
        <!-- <p class="danger-txt" *ngIf="nom_prenom?.errors?.required">
          Veuillez remplir ce champ
        </p> -->
        <p class="danger-txt" *ngIf="nom_prenom?.errors?.minlength">
          Vous devez entrer 6 caractères au moin
        </p>
        <p class="danger-txt" *ngIf="nom_prenom?.errors?.pattern">
          Vous devez entrer seulement des alphabets
        </p>
      </div>
    </div>

    <div class="col-lg-3 form-group mt-4">
      <label for="">N° CIN du Propriétaire</label>
      <input type="text" class="form-control rounded-pill" formControlName="cin"  />
      <!-- Error Message  -->
      <div class="" *ngIf="checkInputsValidation(cin)">
        <p class="danger-txt" *ngIf="cin?.errors?.maxlength">
          Ce champ ne doit pas dépasser 8 caractères
        </p>
        <p class="danger-txt" *ngIf="cin?.errors?.required">
          Veuillez remplir ce champ
        </p>
      </div>
    </div>

    <div class="col-lg-3 form-group mt-4">
      <label for="">Passeport Propriétaire</label>
      <input type="text" class="form-control rounded-pill" formControlName="passport" [ngClass]="{
          'is-invalid': checkInputsValidation(passport)
        }" />
      <!-- Error Message  -->
      <div class="" *ngIf="checkInputsValidation(passport)">
        <p class="danger-txt" *ngIf="passport?.errors?.maxlength">
          Ce champ ne doit pas dépasser 8 caractères
        </p>
      </div>
    </div>

    <div class="col-lg-3 form-group mt-4">
      <label for="">Carte séjour Propriétaire</label>
      <input type="text" class="form-control rounded-pill" formControlName="carte_sejour" [ngClass]="{
          'is-invalid': checkInputsValidation(carte_sejour)
        }" />
      <!-- Error Message  -->
      <div class="" *ngIf="checkInputsValidation(carte_sejour)">
        <p class="danger-txt" *ngIf="carte_sejour?.errors?.maxlength">
          Ce champ ne doit pas dépasser 8 caractères
        </p>
      </div>
    </div>

   
  </div>
  <!--Début 2éme Row-->
  <div class="row">
    
    <div class="col-lg-3 form-group mt-4">
      <label for="">Raison sociale <span class="danger-txt">*</span></label>
      <input type="text" class="form-control rounded-pill" formControlName="raison_social" [ngClass]="{
          'is-invalid': checkInputsValidation(raison_social)
        }" />

      <!-- Error Message  -->
      <div class="" *ngIf="checkInputsValidation(raison_social)">
        <p class="danger-txt" *ngIf="raison_social?.errors?.pattern">
          Vous devez entrer seulement des alphabets
        </p>
      </div>

    </div>
    <div class="col-lg-3 form-group mt-4">
      <label for="">N° de l’Identifiant Fiscal</label>
      <input type="text" class="form-control rounded-pill" formControlName="n_registre_commerce" [ngClass]="{
          'is-invalid': checkInputsValidation(n_registre_commerce)
        }" />

      <!-- Error Message  -->
      <div class="" *ngIf="checkInputsValidation(n_registre_commerce)">
        <p class="danger-txt" *ngIf="n_registre_commerce?.errors?.pattern">
          Vous devez entrer des chiffres
        </p>
      </div>
    </div>

  

    <div class="col-lg-3 form-group mt-4">
      <label for="">Téléphone du propriétaire</label>
      <input type="text" class="form-control rounded-pill" formControlName="telephone" [ngClass]="{
          'is-invalid': checkInputsValidation(telephone)
        }" />

      <!-- Error Message  -->
      <div class="" *ngIf="checkInputsValidation(telephone)">
        <p class="danger-txt" *ngIf="telephone?.errors?.pattern">
          Vous devez entrer seulement des chiffres
        </p>
        <p class="danger-txt" *ngIf="telephone?.errors?.maxlength">
          Vous devez entrer 10 chiffres au maximum
        </p>
      </div>
    </div>

    <div class="col-lg-3 form-group mt-4">
      <label for="">Fax du propriétaire</label>
      <input type="text" class="form-control rounded-pill" formControlName="fax" [ngClass]="{
          'is-invalid': checkInputsValidation(fax)
        }" />

      <!-- Error Message  -->
      <div class="" *ngIf="checkInputsValidation(fax)">
        <p class="danger-txt" *ngIf="fax?.errors?.pattern">
          Vous devez entrer seulement des chiffres
        </p>
        <p class="danger-txt" *ngIf="fax?.errors?.maxlength">
          Vous devez entrer 10 chiffres au maximum
        </p>
      </div>
    </div>
  </div>

  <!--Début 3éme Row-->
  <div class="row">


    <div class="col-lg-3 form-group mt-4">
      <label for="">N° de compte bancaire <span class="danger-txt">*</span></label>
      <input type="text" class="form-control rounded-pill" formControlName="n_compte_bancaire" required [ngClass]="{
          'is-invalid': checkInputsValidation(n_compte_bancaire),
          'is-valid': !n_compte_bancaire?.invalid
        }" maxlength="24"/>

      <!-- Error Message  -->
      <div class="" *ngIf="checkInputsValidation(n_compte_bancaire)">
        <p class="danger-txt" *ngIf="n_compte_bancaire?.errors?.required">
          Veuillez remplir ce champ
        </p>
        <p class="danger-txt" *ngIf="n_compte_bancaire?.errors?.pattern">
          Vous devez entrer 24 caractères(chiffres)
        </p>
      </div>
    </div>

    <!-- <div class="col-lg-3 form-group mt-4">
      <label for="">Banque RIB</label>
      <input type="text" class="form-control rounded-pill" formControlName="banque_rib" required [ngClass]="{
          'is-invalid': checkInputsValidation(banque_rib),
          'is-valid': !banque_rib?.invalid
        }" />

      Error Message 
      <div class="" *ngIf="checkInputsValidation(banque_rib)">
        <p class="danger-txt" *ngIf="banque_rib?.errors?.required">
          Veuillez remplir ce champ
        </p>
        <p class="danger-txt" *ngIf="banque_rib?.errors?.pattern">
          Vous devez entrer 3 caractères(chiffres)
        </p>
      </div>
    </div> -->

    <!-- <div class="col-lg-3 form-group mt-4">
      <label for="">Ville RIB</label>
      <input type="text" class="form-control rounded-pill" formControlName="ville_rib" required [ngClass]="{
          'is-invalid': checkInputsValidation(ville_rib),
          'is-valid': !ville_rib?.invalid
        }" />

      Error Message 
      <div class="" *ngIf="checkInputsValidation(ville_rib)">
        <p class="danger-txt" *ngIf="ville_rib?.errors?.required">
          Veuillez remplir ce champ
        </p>
        <p class="danger-txt" *ngIf="ville_rib?.errors?.pattern">
          Vous devez entrer 3 caractères(chiffres)
        </p>
      </div>
    </div> -->

    <!-- <div class="col-lg-3 form-group mt-4">
      <label for="">Clé RIB</label>
      <input type="text" class="form-control rounded-pill" formControlName="cle_rib" required [ngClass]="{
          'is-invalid': checkInputsValidation(cle_rib),
          'is-valid': !cle_rib?.invalid
        }" />

      Error Message 
      <div class="" *ngIf="checkInputsValidation(cle_rib)">
        <p class="danger-txt" *ngIf="cle_rib?.errors?.required">
          Veuillez remplir ce champ
        </p>
        <p class="danger-txt" *ngIf="cle_rib?.errors?.pattern">
          Vous devez entrer 2 caractères(chiffres)
        </p>
      </div>
    </div> -->

    <div class="col-lg-3 form-group mt-4">
      <label for="">Banque <span class="danger-txt">*</span></label>
      <input type="text" class="form-control rounded-pill" formControlName="banque" required [ngClass]="{
          'is-invalid': checkInputsValidation(banque),
          'is-valid': !banque?.invalid
        }" />

      <!-- Error Message  -->
      <div class="" *ngIf="checkInputsValidation(banque)">
        <p class="danger-txt" *ngIf="banque?.errors?.required">
          Veuillez remplir ce champ
        </p>
        <!-- <p class="danger-txt" *ngIf="banque.errors.minlength">
            CIN doit être au moins 4 caractéres
          </p> -->
      </div>
    </div>

    <div class="col-lg-3 form-group mt-4">
      <label for="">Nom de l’Agence bancaire</label>
      <input type="text" class="form-control rounded-pill" formControlName="nom_agence_bancaire" [ngClass]="{
          'is-invalid': checkInputsValidation(nom_agence_bancaire)
        }" />
    </div>

    <div class="col-lg-12 form-group mt-4">
      <label for="">Adresse du propriétaire <span class="danger-txt">*</span></label>
        <textarea
        type="text"
        class="form-control"
        formControlName="adresse"
        [ngClass]="{
          'is-invalid': checkInputsValidation(adresse),
          'is-valid': !adresse?.invalid
        }"
      ></textarea>
      <!-- Error Message  -->
      <div class="" *ngIf="checkInputsValidation(adresse)">
        <p class="danger-txt" *ngIf="adresse?.errors?.required">
          Veuillez remplir ce champ
        </p>
      </div>
    </div>

    <div class="col-lg-3 form-group mt-4">
      <label for="">Part du propriétaire <span class="danger-txt">*</span></label>
      <input type="number" class="form-control rounded-pill" formControlName="pourcentage"
        (keyup)="calculMontant();calculMontantAvance();calculCaution()" [ngClass]="{
          'is-invalid': checkInputsValidation(pourcentage)
        }"/>
        <!-- Error Message  -->
        <div class="" *ngIf="checkInputsValidation(pourcentage)">
          <p class="danger-txt" *ngIf="pourcentage?.errors?.required">
            Veuillez remplir ce champ
          </p>
        </div>
    </div>


    <div class="col-lg-3 form-group mt-4">
      <label for="">Montant de loyer</label>
      <input type="text" class="form-control rounded-pill" formControlName="montant_loyer" [ngClass]="{
          'is-invalid': checkInputsValidation(montant_loyer)
        }" [value]="montantLoyer" readonly/>
      <!-- Error Message  -->
      <div class="" *ngIf="checkInputsValidation(montant_loyer)">
        <p class="danger-txt" *ngIf="montant_loyer?.errors?.pattern">
          Vous devez entrer seulement des chiffres
        </p>
      </div>
    </div>


    <div class="col-lg-3 form-group mt-4">
      <label for="">Taux de l’impôt</label>
      <input type="text" class="form-control rounded-pill" formControlName="taux_impot" [ngClass]="{
              'is-invalid': checkInputsValidation(taux_impot)
            }" [value]="(tauxImpot && tauxImpot) + '%'" readonly />
    </div>

    <div class="col-lg-3 form-group mt-4">
      <label for="">Retenue à la source</label>
      <input type="text" class="form-control rounded-pill" formControlName="retenue_source" [ngClass]="{
              'is-invalid': checkInputsValidation(retenue_source)
            }" [value]="retenueSource" readonly />
    </div>

    <div class="col-lg-3 form-group mt-4">
      <label for="">Montant après impôt</label>
      <input type="text" class="form-control rounded-pill" formControlName="montant_apres_impot" [ngClass]="{
              'is-invalid': checkInputsValidation(montant_apres_impot)
            }" [value]="montantApresImpot" readonly />
    </div>



    <!-- Montant Avance Taxe -->
    <div class="col-lg-3 form-group mt-4">
      <label for="">Montant d'avance de propriétaire</label>
      <input type="text" class="form-control rounded-pill" [value]="montantAvance"
        formControlName="montant_avance_proprietaire" readonly />
    </div>

    <div class="col-lg-3 form-group mt-4">
      <label for="">Taxe d'avance propriétaire</label>
      <input type="text" class="form-control rounded-pill" [value]="taxAvance | number: '1.2-2'"
        formControlName="tax_avance_proprietaire" readonly />
    </div>

    <!-- <div class="col-lg-3 form-group mt-4">
      <label for="">Taxe par périodicité</label>
      <input type="text" class="form-control rounded-pill" [value]="taxPeriodicite | number: '1.2-2'"
        formControlName="tax_par_periodicite" readonly />
    </div> -->


    <!-- <div class="col-lg-3 form-group mt-4">
          <label for="">Pourcentage</label>
          <input type="text" class="form-control rounded-pill" [value]="pourcentageCaution  | number: '1.2-2'"
            formControlName="pourcentage_caution" readonly />
        </div> -->

    <div class="col-lg-3 form-group mt-4">
      <label for="">Caution par propriétaire</label>
      <input type="text" class="form-control rounded-pill" [value]="montantCautionProprietaire | number: '1.2-2'"
        formControlName="caution_par_proprietaire" readonly />
    </div>

  </div>

  <h4 class="mt-4">Mandataire</h4>
  <div class="col-lg-3 form-group d-flex">
    <label for="">Oui</label>
    <input type="radio" name="is_mandataire" [value]="true" class="form-check-input mx-2" [(ngModel)]="isMand"
      formControlName="is_mandataire" (click)="CheckMandataire(true)" />
    <label for="">Non</label>
    <input type="radio" name="is_mandataire" [value]="false" class="form-check-input mx-2" [(ngModel)]="isMand"
      formControlName="is_mandataire" (click)="CheckMandataire(false)" />
  </div>

  <!-- If isMand true show list of proprietaire to checked -->
  <div *ngIf="isMand && update; then coProprietaireUpdate"></div>
  <div *ngIf="isMand && !update; then coProprietaireAdd"></div>

  <!-- Show the proprietaire list if the lengthProprietaire == 0 if not show an error message -->
  <ng-template #coProprietaireUpdate>
    <h6 class="mt-4">
      Propriétaires sélectionnés
    </h6>
    <div *ngIf="lengthProprietaire" class="d-flex justify-content-start align-items-center flex-wrap gap-2">
      <div *ngFor="let prop of proprietaireList">
        <input type="checkbox" [name]="prop?._id" class="btn-check check" [id]="prop?._id" autocomplete="off"
          [value]="prop?._id" (click)="selectProp(prop)" checked>
        <label class="px-3 py-1 rounded-pill checkbox-list-btns" [for]="prop?._id">
          {{prop?.cin}} • {{prop?.nom_prenom}}
        </label>
      </div>
    </div>

    <div class="mt-1" *ngIf="!proprietaireList.length">
      <!-- Error message -->
      <p class="main-muted-text">Aucun propriétaire à sélectionné</p>
    </div>

    <h6 class="mt-3">
      Propriétaires à sélectionner
    </h6>
    <div *ngIf="lengthProprietaire" class="d-flex justify-content-start align-items-center flex-wrap gap-2">
      <div *ngFor="let proprietaire of proprietaires">
        <input type="checkbox" [name]="proprietaire._id" class="btn-check check" [id]="proprietaire._id"
          autocomplete="off" [value]="proprietaire._id" (click)="selectProp(proprietaire)">
        <label class="px-3 py-1 rounded-pill checkbox-list-btns" [for]="proprietaire._id">
          {{proprietaire.cin}} • {{proprietaire.nom_prenom}}
        </label>
      </div>
    </div>
    <div class="mt-1" *ngIf="!proprietaires.length">
      <!-- Error message -->
      <p class="main-muted-text">Aucun propriétaire à afficher</p>
    </div>
  </ng-template>
    <!--End of coProprietaireUpdate template -->

  <ng-template #coProprietaireAdd>
    <h6 class="mt-4">
      Propriétaires à sélectionner
    </h6>
    <div *ngIf="lengthProprietaire" class="d-flex justify-content-start align-items-center gap-2">
      <div *ngFor="let proprietaire of proprietaires">
        <input type="checkbox" [name]="proprietaire._id" class="btn-check check" [id]="proprietaire._id"
          autocomplete="off" [value]="proprietaire._id" (click)="selectProp(proprietaire)"
          formControlName="proprietaire_list">
        <label class="px-3 py-1 rounded-pill checkbox-list-btns" [for]="proprietaire._id">
          {{proprietaire.cin}} • {{proprietaire.nom_prenom}}
        </label>
      </div>
    </div>
    <div class="mt-1" *ngIf="!proprietaires.length">
      <!-- Error message -->
      <p class="main-muted-text">Aucun propriétaire à afficher</p>
    </div>
  </ng-template>


  <app-confirmation-modal [closeBtn]='false'>
    <h3 class="danger-txt"><i class="fas fa-exclamation-triangle"></i> Attention</h3>
    <blockquote class="blockquote mt-2 text-dark">
      <p>Attention, vous avez dépassé le montant total du loyer !</p>
    </blockquote>
    <figcaption  class="blockquote-footer">Il vous reste seulement {{ pourcentageProprietaire }}% du montant total du loyer.</figcaption>
    <div class="mt-3">
      <a class="btn danger-btn me-2" (click)='roolBack()'>Retour</a>
    </div>
  </app-confirmation-modal>

  <!-- Condition pour afficher ou cacher le formulaire de mandataire -->
  <!-- <div *ngIf="isMand; then mandataire"></div> -->
  <!--  -->
  <!---->

  <!-- Début 2éme Row
  <div class="row mt-4">
    Début de Div Mandataire Qui contient(Title+divForm+Form)
    <ng-template #mandataire>
      Grand Titre Mandataire
      <div class="row mt-3 mb-2">
        <div class="margin-main col-lg-12 mt-3">
          <div class="d-flex justify-content-between">
            <h4 class="main-title">Mandataire</h4>
            <a (click)="addFormMandateire()" class="btn second-btn">Ajouter mandataire</a>
          </div>
        </div>
      </div>

      Début de Conteneur Mandataire
      <div>
        <h6>Remplissage des données</h6>

        Début Div form Mandataire

        Début 3éme Row
        <div formArrayName="mandataireForm" *ngFor="let mandataireItem of mandataireForm.controls; let i = index">

          <div class="main-card mt-4 bg-white p-lg-4" [formGroupName]="i">
            <a (click)="removeFormMandateire(i)" class="btn btn-sm danger-btn float-end"><i
                class="fal fa-trash"></i></a>
            <div class="row">
              <div class="col-lg-3 form-group mt-2">
                <label for="">N° CIN mandataire</label>
                <input type="text" class="form-control rounded-pill" formControlName="cin_mandataire"  />
              </div>

              <div class="col-lg-3 form-group mt-4">
                <label for="">Raison sociale mandataire</label>
                <input type="text" class="form-control rounded-pill" formControlName="raison_social_mandataire" />
              </div>

              <div class="col-lg-3 form-group mt-4">
                <label for="">Nom et prénom mandataire</label>
                <input type="text" class="form-control rounded-pill" formControlName="nom_prenom_mandataire" />
              </div>

              <div class="col-lg-3 form-group mt-4">
                <label for="">Téléphone du mandataire</label>
                <input type="text" class="form-control rounded-pill" formControlName="telephone_mandataire" />
              </div>


              <div class="row">
                <div class="col-lg-3 form-group mt-4">
                  <label for="">Fax du mandataire</label>
                  <input type="text" class="form-control rounded-pill" formControlName="fax_mandataire" />
                </div>

                <div class="col-lg-3 form-group mt-4">
                  <label for="">Adresse du mandataire</label>
                  <input type="text" class="form-control rounded-pill" formControlName="adresse_mandataire" />
                </div>

                <div class="col-lg-3 form-group mt-4">
                  <label for="">N° de compte bancaire M</label>
                  <input type="text" class="form-control rounded-pill" formControlName="n_compte_bancaire_mandataire" />
                </div>
              </div>
            </div>
          </div>
          Fin de 3éme Row
        </div>
        Div form Mandataire End
      </div>
      Fin de Conteneur Mandataire
    </ng-template>
    Fin de Div Mandataire (Title+divForm+Form)
  </div> -->
  <!-- Fin 2éme Row-->

  <!-- Button Modifier & Ajouter -->
  <div class="form-group mt-5 col-lg-3 d-flex">
    <button type="submit" class="btn second-btn form-control" (click)="scrollToTop()" *ngIf="proprietaire != ''">
      <!-- [disabled]="proprietaireForm.invalid" -->
      Modifier
    </button>
    <button type="submit" class="btn second-btn form-control" (click)="scrollToTop()" *ngIf="proprietaire == ''"
      [disabled]="proprietaireForm.invalid">
      Ajouter
    </button>
  </div>
</form>
</div>